<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Creating Animated Graphics</title>
    <meta charset="utf-8" />
    <meta name="author" content=" Xuemao Zhang  East Stroudsburg University" />
    <meta name="date" content="2019-06-26" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="mystyle.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Creating Animated Graphics
## Using the package ‘magick’
### <br>Xuemao Zhang<br> East Stroudsburg University
### June 26, 2019

---





# Overview



* First, install the following packages if you don't have them.

```
               install.packages("ggplot2");
               install.packages("pdftools");                      
               install.packages("gapminder");
               install.packages("magick");

``` 

# Overview

- The [magick](https://cran.r-project.org/web/packages/magick/vignettes/intro.html) package is an ambitious effort to modernize and simplify high-quality image processing in R.
 

- The package `magick` is maintained by [Jeroen Ooms](https://github.com/jeroen). 

- The [magick](https://cran.r-project.org/web/packages/magick/magick.pdf) package can do transformations of graphs, layers and animations. 

- Another animation R package is [gganimate](https://github.com/thomasp85/gganimate) .  It extends the grammar of graphics as implemented by `ggplot2`.  `gganimate` is currently GitHub-only, but will be released on CRAN once ready. 

- `magick` supports the pipe `%&gt;%` operator used in `ggplot2`.

-  First, install and load the `magick` package

```
                    install.packages("magick")
```



```
                    library("magick")
```



---




# Overview


```r
str(magick::magick_config());   #list the formats that ImageMagick supports
```

```
## List of 21
##  $ version           :Class 'numeric_version'  hidden list of 1
##   ..$ : int [1:4] 6 9 9 14
##  $ modules           : logi FALSE
##  $ cairo             : logi TRUE
##  $ fontconfig        : logi FALSE
##  $ freetype          : logi TRUE
##  $ fftw              : logi TRUE
##  $ ghostscript       : logi TRUE
##  $ jpeg              : logi TRUE
##  $ lcms              : logi TRUE
##  $ libopenjp2        : logi FALSE
##  $ lzma              : logi TRUE
##  $ pangocairo        : logi TRUE
##  $ pango             : logi TRUE
##  $ png               : logi TRUE
##  $ rsvg              : logi TRUE
##  $ tiff              : logi TRUE
##  $ webp              : logi TRUE
##  $ wmf               : logi FALSE
##  $ x11               : logi FALSE
##  $ xml               : logi TRUE
##  $ zero-configuration: logi TRUE
```

---

# Overview


-  It wraps the [ImageMagick STL](https://www.imagemagick.org/Magick++/STL.html) which is perhaps the most comprehensive open-source image processing library available today.

&lt;a href="https://www.imagemagick.org"&gt;&lt;img style="float: left; width: 360px; padding:0 50px 0 0;" src="wizard.png"&gt;&lt;/a&gt;

- Overwhelming amount of functions: convert, resize, flip, mirror, rotate, distort, transform image, adjust color, draw text, draw shapes, special effects, ... 

- This lecture note is based on R:vignette [The magick package: Advanced Image-Processing in R](https://cran.r-project.org/web/packages/magick/vignettes/intro.html) and [statsoft](http://www.statsoft.org).


- Lots of image processing functions are discriped in R:vignette [The magick package: Advanced Image-Processing in R](https://cran.r-project.org/web/packages/magick/vignettes/intro.html).  We focus on animated graphics. 






---

# Overview

- Example (Beating Heart): Mathematical "heart curves" at [Wolfram MathWorld](http://mathworld.wolfram.com/HeartCurve.html). Here is another [heart formula](http://www.statsoft.org) that can be made animating with varying parameter: 

$$
\frac{1}{2}|xy| - \frac{3a}{4}x^2 - \frac{4a}{7}y^2 - ay \geq 0, ~~ a\in[0.9, 1.3]
$$


```r
img &lt;- image_graph(300, 300, res = 36)
n = 300
X = matrix(rep(seq(-1.4, 1.4, length=n), n), nrow=n, byrow=F); 
Y = matrix(rep(seq(0.1, -2.5, length=n), n), nrow=n, byrow=T); 
for (a in seq(0.9, 1.3, length = 2)) {
  Z = abs(X*Y)/2 - 3*a*X^2/4 - 4*a*Y^2/7 - a*Y;
  Z[Z&lt;=0] = NA;
  par(mar = c(1,1,1,1));
  image(Z, col=2, ann = FALSE); 
} 
dummy = dev.off(); 
img %&gt;% image_trim() %&gt;% image_animate(fps = 1) %&gt;% image_write("Heart.gif");
```

---

# Overview

- Example (Beating Heart)

&lt;img src="Heart.gif" width="40%" style="display: block; margin: auto;" /&gt;

---
class: center, middle

# 1. Image Processing 

&lt;br &gt;




---

# Image IO: read and write

- `magick`  automatically converts and renders all common image formats. 

- Images can be read directly from a file path, URL, or raw vector with image data with the function `image_read()`. 


```r
library(magick);
frink=image_read('https://jeroen.github.io/images/frink.png'); print(frink);
```

```
## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      220    445 sRGB       TRUE     73494 72x72
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-4-1.png" width="20%" style="display: block; margin: auto;" /&gt;


---

# Image IO: converting formats

- We use `image_write()` to export an image in any format to a file on disk, or in memory if `path = NULL`.


```r
image_write(frink, path = "frink.png", format = "png"); 
```

- `magick` keeps the image in memory in it's original format. Specify the `format` parameter in `image_convert()` to convert to another format. 



```r
frink_gif=image_convert(frink,  format = "gif"); # convert from png to gif
```


---

# Image IO: Preview

- IDE's with a built-in web browser (as you have seen in RStudio) automatically display magick images in the viewer. This results in a neat interactive image editing environment.



```r
print(frink);
```

```
## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      220    445 sRGB       TRUE     73494 72x72
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-8-1.png" width="20%" style="display: block; margin: auto;" /&gt;


---
class: center, middle

# 2. Transformations

&lt;br &gt;




---

# Transformations: Resize

- resize proportionally to width


```r
image_scale(frink, "300"); #width: 300px
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-9-1.png" width="20%" style="display: block; margin: auto;" /&gt;

---

# Transformations: Resize

- resize proportionally to height


```r
image_scale(frink, "x300"); # height: 300px
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-10-1.png" width="20%" style="display: block; margin: auto;" /&gt;


---

# Transformations: Rotate

- Rotate a graph


```r
image_rotate(frink, 45);
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-11-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

# Transformations: Mirror

- Mirror a graph


```r
image_flip(frink);
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-12-1.png" width="20%" style="display: block; margin: auto;" /&gt;

---

# Transformations: Mirror

- Mirror a graph


```r
image_flop(frink);
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-13-1.png" width="20%" style="display: block; margin: auto;" /&gt;

---

# Transformations: Brightness, Saturation, Hue



```r
image_modulate(frink, brightness = 80, saturation = 120, hue = 90);
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-14-1.png" width="20%" style="display: block; margin: auto;" /&gt;


---

# Transformations: image fill

- With image_fill we can flood fill starting at pixel point. The fuzz parameter allows for the fill to cross for adjacent pixels with similarish colors.  


```r
image_fill(frink, "orange", point = "+100+200", fuzz = 20); ## Paint the shirt orange
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-15-1.png" width="20%" style="display: block; margin: auto;" /&gt;

---

# Text annotation

- It can be useful to print some text on top of images.  See https://cran.r-project.org/web/packages/magick/vignettes/intro.html#cut_and_edit for more information.


```r
# Add some text
image_annotate(frink, "I like R!", size = 70, gravity = "southwest", color = "green");
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-16-1.png" width="20%" style="display: block; margin: auto;" /&gt;

---
# The pipe `%&gt;%` operator

- `magick` supports the pipe `%&gt;%` operator used in `ggplot2`.


```r
frink1 = image_read('https://jeroen.github.io/images/frink.png')%&gt;%
  image_rotate(270) %&gt;% 
  image_scale("300") %&gt;%
  image_background("hotpink") %&gt;%
  image_border("#000080", "20x10") %&gt;%
  image_annotate("ESU Data Camp", color = "red", location ="+25+12", size = 20);
print(frink1);
```

```
## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      340    168 sRGB       TRUE         0 72x72
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-17-1.png" width="453" style="display: block; margin: auto;" /&gt;

---
class: center, middle

# 3. Image Vectors

&lt;br &gt;


---

# What is animation?


 - [**Animation**](https://www.computerhope.com/jargon/a/animatio.htm) is the illusion of movement created by showing a series of still pictures in rapid succession. 
    - For example, an animated GIF image is comprised of multiple images.  Each of these images must be the same size, in terms of width and height.  The image should not exceed 256 colors.
    
    
-  All functions in `magick` have been **vectorized** to support working with layers, compositions or animation.  Each image can be a component of a vector.

- The standard base vector methods `[ [[`, `$`, `c()` and `length()` are used to manipulate sets of images which can then be treated as **layers** or **frames**. 


- The following example shows the layers/frames information of an animated GIF image.


```r
# Download earth gif and make it a bit smaller
earth = image_read("https://jeroen.github.io/images/earth.gif")%&gt;%image_scale("200x");
earth;
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-18-1.gif" width="20%" style="display: block; margin: auto;" /&gt;


---

# What is animation?


```r
length(earth);
```

```
## [1] 44
```

```r
head(image_info(earth));
```

```
## # A tibble: 6 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 GIF      200    200 sRGB       FALSE        0 72x72  
## 2 GIF      200    200 sRGB       FALSE        0 72x72  
## 3 GIF      200    200 sRGB       FALSE        0 72x72  
## 4 GIF      200    200 sRGB       FALSE        0 72x72  
## 5 GIF      200    200 sRGB       FALSE        0 72x72  
## 6 GIF      200    200 sRGB       FALSE        0 72x72
```


---

# Layers

- We can **stack layers** on top of each other as we would in Photoshop.


```r
bigdata = image_read('https://jeroen.github.io/images/bigdata.jpg');
frink = image_read("https://jeroen.github.io/images/frink.png");
img = c(bigdata, frink) %&gt;% image_scale("300x300");
img;
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-20-1.png" width="20%" style="display: block; margin: auto;" /&gt;

```r
image_info(img);
```

```
## # A tibble: 2 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 JPEG     300    225 sRGB       FALSE        0 72x72  
## 2 PNG      148    300 sRGB       TRUE         0 72x72
```

---

# Layers


- Composing allows for combining two images on a specific position


```r
frink2=frink%&gt;%image_background("none")%&gt;%image_rotate(300)%&gt;% image_scale("x200");
image_composite(image_scale(bigdata, "x400"), frink2, offset = "+180+100");
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-21-1.png" width="50%" style="display: block; margin: auto;" /&gt;

```r
image_write(frink2, path = "frink2.gif", format = "gif");
```

---

# pages

- When reading a PDF document, each page becomes an element of the vector. Note that PDF gets rendered while reading so you need to specify the density immediately.



```r
library(pdftools);
# V5animation.pdf is a pdf file with each page a graph
V5 = image_read_pdf('F:/DataCamp/data/V5animation.pdf', density = 72);
image_info(V5);
```

```
## # A tibble: 15 x 7
##    format width height colorspace matte filesize density
##    &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
##  1 PNG      288    288 sRGB       TRUE         0 72x72  
##  2 PNG      288    288 sRGB       TRUE         0 72x72  
##  3 PNG      288    288 sRGB       TRUE         0 72x72  
##  4 PNG      288    288 sRGB       TRUE         0 72x72  
##  5 PNG      288    288 sRGB       TRUE         0 72x72  
##  6 PNG      288    288 sRGB       TRUE         0 72x72  
##  7 PNG      288    288 sRGB       TRUE         0 72x72  
##  8 PNG      288    288 sRGB       TRUE         0 72x72  
##  9 PNG      288    288 sRGB       TRUE         0 72x72  
## 10 PNG      288    288 sRGB       TRUE         0 72x72  
## 11 PNG      288    288 sRGB       TRUE         0 72x72  
## 12 PNG      288    288 sRGB       TRUE         0 72x72  
## 13 PNG      288    288 sRGB       TRUE         0 72x72  
## 14 PNG      288    288 sRGB       TRUE         0 72x72  
## 15 PNG      288    288 sRGB       TRUE         0 72x72
```

---

# Frames

-  We can also make images frames in an animation!



```r
image_animate(image_scale(img, "200x200"), fps = 1); # fps means frames per second; 
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-23-1.gif" width="50%" style="display: block; margin: auto;" /&gt;

---
class: center, middle

# 4. R graphics device

&lt;br &gt;


---

# Graphics device


- The `image_graph()` function opens a new graphics. It returns an image object to which the plot(s) will be written. Each "page" in the plotting device will become a **frame** in the image object.



```r
# Produce image using graphics device
fig = image_graph(width = 400, height = 400, res = 96);
ggplot2::qplot(mpg, wt, data = mtcars, colour = cyl);
dev.off();  # dev.off() shuts down the current device
```

```
## png 
##   2
```

```r
print(fig);
```

```
## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      400    400 sRGB       TRUE         0 72x72
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-24-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---

# Graphics device

- Then we can easily post-process the figure using regular image operations.


```r
out =image_composite(fig, frink, offset = "+70+30"); print(out);
```

```
## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      400    400 sRGB       TRUE         0 72x72
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-25-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---

# Animated Graphics: an example

- The graphics device supports **multiple frames** which makes it easy to create animated graphics. 

- A small demonstration data sampled every five years. 


```r
library(gapminder);
summary(gapminder);
```

```
##         country        continent        year         lifeExp           pop              gdpPercap       
##  Afghanistan:  12   Africa  :624   Min.   :1952   Min.   :23.60   Min.   :6.001e+04   Min.   :   241.2  
##  Albania    :  12   Americas:300   1st Qu.:1966   1st Qu.:48.20   1st Qu.:2.794e+06   1st Qu.:  1202.1  
##  Algeria    :  12   Asia    :396   Median :1980   Median :60.71   Median :7.024e+06   Median :  3531.8  
##  Angola     :  12   Europe  :360   Mean   :1980   Mean   :59.47   Mean   :2.960e+07   Mean   :  7215.3  
##  Argentina  :  12   Oceania : 24   3rd Qu.:1993   3rd Qu.:70.85   3rd Qu.:1.959e+07   3rd Qu.:  9325.5  
##  Australia  :  12                  Max.   :2007   Max.   :82.60   Max.   :1.319e+09   Max.   :113523.1  
##  (Other)    :1632
```
- See more complete data in [Gapminder Data](http://www.gapminder.org/data/),[UN Data](http://data.un.org/) and [World Bank Open Data](https://data.worldbank.org/)


---

# Animated Graphics: an example


```r
library(ggplot2);
Years = unique(gapminder$year); #obtain all years
Img = image_graph(600, 340, res = 96); #open a new graphics device
for (k in 1:length(Years)){
data = gapminder[gapminder$year==Years[k], ]; #subset by year
p=ggplot(data, aes(data$gdpPercap, data$lifeExp, size = pop, color = data$continent)) +
  scale_size("population", limits = range(data$pop)) +
  geom_point() + ylim(20, 90) + 
  scale_x_log10(limits = range(data$gdpPercap)) + # log transformation
ggtitle(data$year) + labs(x ="gdpPercap", y = "lifeExp")+theme_classic();
print(p);
}
dev.off();
```

```
## png 
##   2
```

```r
Img_Animation =image_animate(Img, fps = 1);
```



---

# Animated Graphics: an example


```r
image_write(Img_Animation, path = "Img_Animation.gif"); # write it to a file
print(Img_Animation); 
```

```
## # A tibble: 12 x 7
##    format width height colorspace matte filesize density
##    &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
##  1 gif      600    340 sRGB       TRUE         0 72x72  
##  2 gif      600    340 sRGB       TRUE         0 72x72  
##  3 gif      600    340 sRGB       TRUE         0 72x72  
##  4 gif      600    340 sRGB       TRUE         0 72x72  
##  5 gif      600    340 sRGB       TRUE         0 72x72  
##  6 gif      600    340 sRGB       TRUE         0 72x72  
##  7 gif      600    340 sRGB       TRUE         0 72x72  
##  8 gif      600    340 sRGB       TRUE         0 72x72  
##  9 gif      600    340 sRGB       TRUE         0 72x72  
## 10 gif      600    340 sRGB       TRUE         0 72x72  
## 11 gif      600    340 sRGB       TRUE         0 72x72  
## 12 gif      600    340 sRGB       TRUE         0 72x72
```

&lt;img src="2_Animations_files/figure-html/unnamed-chunk-28-1.gif" width="30%" style="display: block; margin: auto;" /&gt;


---

# Animated Graphics: an example

&lt;img src="Img_Animation.gif" width="80%" style="display: block; margin: auto;" /&gt;

---
class: center, middle

# Thank you!
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
